##### Tomcat系统架构与原理剖析

###### 两大核心功能

1. 和客户端浏览器进行交互，进行socket通信，将字节流和Request/Response对象进行转换

2. Servlet容器处理业务逻辑

   tomcat设计了两个核心组件：连接器（Connector）和容器（Container）来完成两个核心功能

   连接器：负责与客户端进行交互。处理Socket连接；负责网络字节流与Request/Response对象的转化

   容器：负责内部处理。加载和管理Servlet；处理Request请求

##### 连接器组件Coyote

Coyote是tomcat中连接器的组件名称，是对外的接口。客户端通过Coyote与服务器建立连接、发送请求并接受响应

1. Coyote封装了底层的网络通信（Socket请求及响应）

2. Coyote使Catalina容器与具体的请求协议及IO操作方式完全解耦

3. Coyote将Socket输入流转换封装为Request对象，进一步封装后交由Catalina容器进行处理，处理请求完成后，Catalina通过Coyote提供的Response对象将结果写入输出流

4. Coyote负责具体协议（应用层）和IO（传输层）相关内容

   ![image-20200522211327681](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200522211327681.png)

Coyote支持的应用层协议和I/O模型

应用层协议：

1.  HTTP/1.1 大部分web应用采用的访问协议
2.  HTTP/2 自8.5以及9.0版本之后支持，2.0大幅度的提升了web性能
3.  AJP  用于和WX集成（如Apache），以实现对静态资源的优化以及集群部署，当前支持AJP/1.3

传输层I/O模型：

1. NIO 非阻塞I/O，采用java NIO类库实现
2. NIO2 异步I/O，采用JDK 7 最新的NIO2类库实现
3. APR 采用Apache可移植运行库实现，是C/C++编写的本地库。如果选择该方案，需要单独安装APR库

在8.0之前，Tomcat默认采用的I/O方式为BIO，之后改为NIO。无论NIO、NIO2还是APR，在性能方面均优于以往的BIO。如果采用APR，甚至可以达到Apache HTTP Server的影响性能

Coyote的内部组件及流程

![image-20200522221221193](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200522221221193.png)

Coyote组件及作用

![image-20200522221308925](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200522221308925.png)

###### Tomcat Servlet容器Catalina

Tomcat是一个由一系列可配置（conf/server.xml）的组件构成的web容器，而Catalina是Tomcat的servlet容器

![image-20200522222901449](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200522222901449.png)

其实，可以认为整个Tomcat就是一个Catalina实例，Tomcat启动的时候会初始化这个实例，Catalina实例通过加载server.xml完成其他实例的创建，创建并管理一个Server，Server创建并管理多个服务，每个服务又可以有多个Connector和一个Container

一个Catalina实例（容器）

一个Server实例（容器）

多个Service实例（容器）

每一个Service实例上可以有多个Connector实例和一个Container实例

- Catalina

  负责解析tomcat的配置文件（server.xml），以此来创建服务器Server组件并进行管理

- Server

  服务器表示整个Catalina Servlet容器以及其它组件，负责组装并启动Servlet引擎，Tomcat连接器。Server通过实现Lifecycle接口，提供了一种优雅的启动和关闭整个系统的方式

- Service

  服务是Server内部的组件，一个Server包含多个Service。它将若干个Connector组件绑定到一个Container

- Container

  容器，负责处理用户的servlet请求，并返回对象给web用户的模块

###### Container组件的具体结构

![image-20200524094038058](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200524094038058.png)

- Engine

  表示整个Catalina的Servlet引擎，用来管理多个虚拟站点，一个Service最多只能有一个Engine，但是一个引擎可包含多个Host

- Host

  虚拟主机，可以给Tomcat配置多个虚拟主机地址，而一个虚拟主机下可包含多个Context

- Context

  web应用程序，一个web应用可包含多个Wrapper

- Wrapper

  一个Wrapper表示一个Servlet

  上述组件的配置其实就体现在conf/server.xml中

##### Tomcat核心配置

核心配置在tomcat目录下的conf/server.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!-- Note:  A "Server" is not itself a "Container", so you may not
     define subcomponents such as "Valves" at this level.
     Documentation at /docs/config/server.html
 -->
<!--Server根元素-->
<!--
	port:关闭服务器的监听端口
	shutdown:关闭服务器的指令字符串
-->
<Server port="8005" shutdown="SHUTDOWN">
    <!--定义监听器-->
    <!--
		以日志形式输出服务器、操作系统、JVM的版本信息
	-->
  <Listener className="org.apache.catalina.startup.VersionLoggerListener" />
  <!-- Security listener. Documentation at /docs/config/listeners.html
  <Listener className="org.apache.catalina.security.SecurityListener" />
  -->
  <!--APR library loader. Documentation at /docs/apr.html -->
    <!--
	加载和销毁APR。如果找不到APR库则会输出日志（不影响Tomcat启动
）
-->
  <Listener className="org.apache.catalina.core.AprLifecycleListener" SSLEngine="on" />
  <!-- Prevent memory leaks due to use of particular java/javax APIs-->
    <!--
	避免JRE内存泄漏问题
-->
  <Listener className="org.apache.catalina.core.JreMemoryLeakPreventionListener" />
  <!--
	加载和销毁全局命名服务
-->
    <Listener className="org.apache.catalina.mbeans.GlobalResourcesLifecycleListener" />
    <!--
	在Context停止时重建Executor池中的线程，以避免ThreadLocal相关的内存泄露
-->
  <Listener className="org.apache.catalina.core.ThreadLocalLeakPreventionListener" />

  <!-- Global JNDI resources
       Documentation at /docs/jndi-resources-howto.html
  -->
   <!--定义服务器的全局命名服务-->
  <GlobalNamingResources>
    <!-- Editable user database that can also be used by
         UserDatabaseRealm to authenticate users
    -->
    <Resource name="UserDatabase" auth="Container"
              type="org.apache.catalina.UserDatabase"
              description="User database that can be updated and saved"
              factory="org.apache.catalina.users.MemoryUserDatabaseFactory"
              pathname="conf/tomcat-users.xml" />
  </GlobalNamingResources>

  <!-- A "Service" is a collection of one or more "Connectors" that share
       a single "Container" Note:  A "Service" is not itself a "Container",
       so you may not define subcomponents such as "Valves" at this level.
       Documentation at /docs/config/service.html
   -->
    <!--
	定义service容器
	默认使用org.apache.catalina.core.StandardService
	默认情况下，Tomcat仅指定了Service的名称，值为Catalina
	子标签有：
		Listener添加生命周期监听器
		Executor配置Service共享线程池
		Connector配置Service包含的连接器
		Engine配置Service中连接器对应的Servlet容器引擎
-->
  <Service name="Catalina">

    <!--The connectors can use a shared executor, you can define one or more named thread pools-->
      <!--
		name:线程池名称
		namePrefix:所创建的每个线程的名称前缀
		maxThread:最大线程数
		minSpareThreads:活跃线程数/核心线程数
		maxIdleTime:线程空闲时间，超过该时间后空闲线程会被销毁，默认值为6000，单位毫秒
		maxQueueSize:队列大小，默认Integer.MAX_VALUE
		prestartmainSpareThreads:创建线程池时是否启动minSpareThreads线程，默认false不启动
		threadPriority:线程优先级，默认值5（范围1-10）
		className:指定线程池实现类，默认实现类为org.apache.catalina.core.StandardThreadExecutor。如果想使用自定义线程池首先需要实现org.apache.catalina.Executor接口
-->
    <!--
    <Executor name="tomcatThreadPool" namePrefix="catalina-exec-"
        maxThreads="150" minSpareThreads="4"/>
    -->


    <!-- A "Connector" represents an endpoint by which requests are received
         and responses are returned. Documentation at :
         Java HTTP Connector: /docs/config/http.html
         Java AJP  Connector: /docs/config/ajp.html
         APR (HTTP/AJP) Connector: /docs/apr.html
         Define a non-SSL/TLS HTTP/1.1 Connector on port 8080
    -->
      <!--
		port:端口号，Connector用于创建服务端Socket并监听此端口等待客户端请求。如果该属性设置为0，则生成随机端口
		protocol:支持的访问协议。默认HTTP/1.1，并采用自动切换机制选择一个基于Java NIO的连接器或者基于本地APR连接器（根据本地是否含有Tomcat的本地库判定）
		connectionTimeOut:超时时间，单位为毫秒，-1表示不超时
		redirectPort:当前Connector不支持SSL请求，接收到了一个请求，并且也符合security-constraint约束，需要SSL传输，Catalina自动将请求重定向到指定的端口
		executor:指定共享线程池的名称，也可以通过maxThreads,minSpareThreads等属性配置内部线程池
		URIEncoding：指定URI的字符编码，Tomcat8.X版本默认UTF-8，Tomcat7.x默认ISO-8859-1
-->
    <Connector port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />
    <!-- A "Connector" using the shared thread pool-->
    <!--
    <Connector executor="tomcatThreadPool"
               port="8080" protocol="HTTP/1.1"
               connectionTimeout="20000"
               redirectPort="8443" />
    -->
    <!-- Define an SSL/TLS HTTP/1.1 Connector on port 8443
         This connector uses the NIO implementation. The default
         SSLImplementation will depend on the presence of the APR/native
         library and the useOpenSSL attribute of the
         AprLifecycleListener.
         Either JSSE or OpenSSL style configuration may be used regardless of
         the SSLImplementation selected. JSSE style configuration is used below.
    -->
    <!--
    <Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"
               maxThreads="150" SSLEnabled="true">
        <SSLHostConfig>
            <Certificate certificateKeystoreFile="conf/localhost-rsa.jks"
                         type="RSA" />
        </SSLHostConfig>
    </Connector>
    -->
 

    <!-- Define an AJP 1.3 Connector on port 8009 -->
    <!--
    <Connector protocol="AJP/1.3"
               address="::1"
               port="8009"
               redirectPort="8443" />
    -->

    <!-- An Engine represents the entry point (within Catalina) that processes
         every request.  The Engine implementation for Tomcat stand alone
         analyzes the HTTP headers included with the request, and passes them
         on to the appropriate Host (virtual host).
         Documentation at /docs/config/engine.html -->

    <!-- You should set jvmRoute to support load-balancing via AJP ie :
    <Engine name="Catalina" defaultHost="localhost" jvmRoute="jvm1">
    -->
      <!--
		Engine表示Servlet引擎
		name:指定Engine的名称，默认为Catalina
		defaultHost:默认使用的虚拟机名称，当客户端请求指向的主机无效时，将交友默认的虚拟机处理，默认为localhost
-->
    <Engine name="Catalina" defaultHost="localhost">

      <!--For clustering, please take a look at documentation at:
          /docs/cluster-howto.html  (simple how to)
          /docs/config/cluster.html (reference documentation) -->
      <!--
      <Cluster className="org.apache.catalina.ha.tcp.SimpleTcpCluster"/>
      -->

      <!-- Use the LockOutRealm to prevent attempts to guess user passwords
           via a brute-force attack -->
      <Realm className="org.apache.catalina.realm.LockOutRealm">
        <!-- This Realm uses the UserDatabase configured in the global JNDI
             resources under the key "UserDatabase".  Any edits
             that are performed against this UserDatabase are immediately
             available for use by the Realm.  -->
        <Realm className="org.apache.catalina.realm.UserDatabaseRealm"
               resourceName="UserDatabase"/>
      </Realm>
        
        
	<!--虚拟主机-->
      <Host name="localhost"  appBase="webapps"
            unpackWARs="true" autoDeploy="true">

        <!-- SingleSignOn valve, share authentication between web applications
             Documentation at: /docs/config/valve.html -->
        <!--
        <Valve className="org.apache.catalina.authenticator.SingleSignOn" />
        -->

        <!-- Access log processes all example.
             Documentation at: /docs/config/valve.html
             Note: The pattern used is equivalent to using pattern="common" -->
        <Valve className="org.apache.catalina.valves.AccessLogValve" directory="logs"
               prefix="localhost_access_log" suffix=".txt"
               pattern="%h %l %u %t &quot;%r&quot; %s %b" />
          
          <!--
			web应用 访问路径http://Host name:8080/demo
			docBase:web应用目录或者war包的部署路径。可以是绝对路径，也可以是相对Host appBase的相对路径
 			path:web应用的Context路径
		-->
          <Context docBase="/Users/demo" path="/web"></Context>

      </Host>
    </Engine>
  </Service>
</Server>

```



##### Tomcat源码构建及核心流程源码刨析

###### 源码构建

1. 下载源码

   进入官网，下载源码，以apache-tomcat-8.5.50为例

2. 源码导入IDE前的准备工作

   进入apache-tomcat-8.5.50.src目录，创建pom.xml文件，内容如下

   ```xml
   <?xml version="1.0" encoding="UTF-8"?>
    <project xmlns="http://maven.apache.org/POM/4.0.0"        
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"         
    xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 
    http://maven.apache.org/xsd/maven-4.0.0.xsd">
    
     <modelVersion>4.0.0</modelVersion>   
     <groupId>org.apache.tomcat</groupId>   
     <artifactId>apache-tomcat-8.5.50-src</artifactId>   
     <name>Tomcat8.5</name>    
     <version>8.5</version>
     
      <build>       
      <finalName>Tomcat8.5</finalName>       
      <sourceDirectory>java</sourceDirectory>       
      <resources>           
      <resource>               
      <directory>java</directory>            
      </resource>       
      </resources>       
      <plugins> 
      <plugin>               
      <groupId>org.apache.maven.plugins</groupId>               
      <artifactId>maven-compiler-plugin</artifactId>              
      <version>3.1</version>              
      <configuration>                    
      <encoding>UTF-8</encoding>                   
      <source>11</source>                   
      <target>11</target>              
      </configuration>            
      </plugin>        
      </plugins>    
      </build>
    
     <dependencies>       
     <dependency>           
     <groupId>org.easymock</groupId>            
     <artifactId>easymock</artifactId>           
     <version>3.4</version>        
     </dependency>       
     <dependency>           
     <groupId>ant</groupId>            
     <artifactId>ant</artifactId>
         <version>1.7.0</version>       
   	  </dependency>     
   	  <dependency>           
   	  <groupId>wsdl4j</groupId>          
   	  <artifactId>wsdl4j</artifactId>         
   	  <version>1.6.2</version>       
   	  </dependency>       
   	  <dependency>          
   	  <groupId>javax.xml</groupId>          
   	  <artifactId>jaxrpc</artifactId>         
   	  <version>1.1</version>       
   	  </dependency>        
   	  <dependency>          
   	  <groupId>org.eclipse.jdt.core.compiler</groupId>           
   	  <artifactId>ecj</artifactId>          
   	  <version>4.5.1</version>        
   	  </dependency>       
   	  <dependency>           
   	  <groupId>javax.xml.soap</groupId>          
   	  <artifactId>javax.xml.soap-api</artifactId>           
   	  <version>1.4.0</version>      
   	  </dependency>    
   	  </dependencies> 
   	  
   	  </project>
   
   ```

   进入apache-tomcat-8.5.50.src目录，创建source目录

   将conf、webapps目录移动到source目录中

3. 导入源码到IDE并进行配置

   导入源码

   配置VM参数，因为tomcat源码运行也需要加载配置文件

   ```
   -Dcatalina.home=/Users/yingdian/workspace/servers/apache-tomcat-8.5.50src/source -Dcatalina.base=/Users/yingdian/workspace/servers/apache-tomcat-8.5.50src/source -Djava.util.logging.manager=org.apache.juli.ClassLoaderLogManager -Djava.util.logging.config.file=/Users/yingdian/workspace/servers/apachetomcat-8.5.50-src/source/conf/logging.properties
   ```

   注：如果遇见无法编译JSP的错误，需要在tomcat的源码ContextConfig类中configureStart()方法增加一行代码将JSP引擎初始化

   ![image-20200525192321575](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200525192321575.png)

###### 核心流程源码刨析

主要关注两个流程：tomcat启动流程和tomcat请求处理流程

tomcat启动流程

![image-20200525192628662](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200525192628662.png)

tomcat请求处理流程

![image-20200525192720319](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200525192720319.png)

##### Tomcat类加载机制刨析

![image-20200525193213894](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200525193213894.png)

- 引导类加载器和扩展类加载器的作用不变

- 系统类加载器正常情况下加载CLASSPATH下的类，但是Tomcat的启动脚本并未使用该变量，而是加载tomcat启动类，比如bootstrap.jar，通常在catalina.bat或者catalina.sh中指定，位于CATALINA_HOME/bin下

- Commons通用类加载器加载通用的一些类，位于CATALINA_HOME/lib下，比如servlet-api.jar

- Catalina类加载器用于加载服务器内部可见类，这些类应用程序不能访问

- Shared类加载器用于加载应用程序共享类，这些类服务器不会依赖

- Webapp类加载器，每个应用程序都会有一个独一无二的webapp类加载器，用来加载应用程序下/WEB-INF/classes和/WEB-INF/lib下的类

  tomcat8.5默认改变了严格的双亲委派机制

  - 首先Bootstarp加载
  - 如果未加载到，则从/WEB-INF/classe加载
  - 如果未加载到，则从/WEB-INF/lib/*.jar加载
  - 如果未加载到，则依次从system,common,shared加载（此处遵循双亲委派机制）

##### Tomcat对Https的支持

HTTPS：超文本传输安全协议。是以安全为目标的HTTP通道，在HTTP的基础上通过传输加密和身份认证保证了传输过程的安全性。HTTPS在在HTTP的基础上加了SSL层

###### HTTPS和HTTP的主要区别

- HTTPS协议使用时需要到电子商务认证授权机构（CA）申请SSL证书
- HTTP默认使用8080端口，HTTPS默认使用8443端口
- HTTPS则是具有SSL加密的安全性传输协议，对数据的传输进行加密
- HTTP的连接是无状态的，不安全的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输，身份认证的协议

###### HTTPS工作原理

![image-20200525205009381](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200525205009381.png)

###### tomcat对HTTPS的支持

1. 使用JDK中的keytool工具生成免费的秘钥库文件（证书）

   ```
   keytool -genkey -alias xxx -keyalg RSA -keystore xxx.store
   ```

2. 配置conf/server.xml

   ```xml
   <Connector port="8443" protocol="org.apache.coyote.http11.Http11NioProtocol"    maxThreads="150" schema="https" secure="true" SSLEnabled="true">    <SSLHostConfig>        <Certificate certificateKeystoreFile="/Users/yingdian/workspace/servers/apache-tomcat8.5.50/conf/lagou.keystore" certificateKeystorePassword="lagou123"  type="RSA" />    </SSLHostConfig> </Connector>
   ```

   使用8443端口访问

##### Tomcat性能优化

tomcat优化从两个方面进行：JVM优化、tomcat配置优化

###### JVM虚拟机优化

JVM虚拟机的优化主要是内存分配和垃圾回收策略的优化

​	内存直接影响服务的运行效率和吞吐量

​	垃圾回收机制会不同程度的导致程序运行中断

Java虚拟机内存相关参数

| 参数                 | 参数作用                              |
| -------------------- | ------------------------------------- |
| -server              | 以服务端模式运行                      |
| -Xms                 | 初始堆内存                            |
| -Xmx                 | 最大堆内存                            |
| -XX:MetaspaceSize    | 元空间初始值                          |
| -XX:MaxMetaspaceSize | 元空间最大内存                        |
|                      |                                       |
|                      |                                       |
| -XX:SurvivorRatio    | Eden区与Survivor区大小的比值，默认为8 |

垃圾回收性能指标

​	吞吐量：工作时间（排除GC时间）占总时间的百分比

​	暂停时间：由垃圾回收导致的应用程序停止的时间

垃圾收集器

​	串行收集器：单线程执行所有的垃圾回收工作，适用于单核CPU服务器

​	并行收集器：以并行的方式执行年轻代的垃圾回收，该方式可以显著降低垃圾回收的开销，适用于多处理器上运行的数据量较大的应用

​	并发收集器：以并发的方式执行大部分的垃圾回收工作，以缩短垃圾回收的暂停时间。适用于响应时间优于吞吐量的应用

​	CMS收集器：并发标记清除收集器，适用于哪些更愿意缩短垃圾回收暂停时间并担负得起与垃圾收集器共享处理器资源的应用

​	G1收集器：适用于大容量内存的多核处理器，可以在满足垃圾回收暂停时间的同时，实现高吞吐量

垃圾回收器参数

![image-20200525211853651](C:\Users\x1850\AppData\Roaming\Typora\typora-user-images\image-20200525211853651.png)

###### tomcat自身配置优化

- 调整tomcat线程池

- 调整tomcat连接器

- 禁用AJP连接器

- 调整IO模式

- 动静分离

  















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































